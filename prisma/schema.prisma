// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Railway: direct connection for migrations
}

// ============================================================================
// MUSIC CONTENT MODELS
// ============================================================================

enum PieceType {
  PRELUDE
  FUGUE
}

enum KeyMode {
  MAJOR
  MINOR
}

enum VoiceName {
  SOPRANO
  ALTO
  TENOR
  BASS
  FIFTH
}

model Piece {
  id                   String       @id @default(cuid())
  bwvNumber            Int          @unique // BWV number (e.g., 846 for C major prelude)
  book                 Int          // 1 or 2
  numberInBook         Int          // 1-24
  type                 PieceType
  keyTonic             String       // e.g., "C", "C#", "Bb"
  keyMode              KeyMode
  timeSignature        String       // e.g., "4/4", "3/8"
  tempoSuggestionBpm   Int?
  totalMeasures        Int
  voiceCount           Int?         // Primarily for fugues
  totalDurationSeconds Float?
  musicxmlPath         String?
  midiPath             String?
  metadata             Json?        // Additional flexible data
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  measures         Measure[]
  annotations      Annotation[]
  featureInstances FeatureInstance[]

  @@unique([book, numberInBook, type])
  @@index([bwvNumber])
  @@index([keyTonic, keyMode])
  @@index([type])
}

model Measure {
  id               String   @id @default(cuid())
  pieceId          String
  measureNumber    Int      // 1-based measure number
  beatCount        Int      // Beats in this measure
  isPickup         Boolean  @default(false)
  isFinal          Boolean  @default(false)
  startTimeSeconds Float?
  endTimeSeconds   Float?
  localKey         String?  // Key if different from piece key
  localMode        KeyMode? // Mode if different from piece mode
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  piece       Piece        @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  notes       Note[]
  annotations Annotation[]

  @@unique([pieceId, measureNumber])
  @@index([pieceId])
  @@index([measureNumber])
}

model Note {
  id            String       @id @default(cuid())
  measureId     String
  voice         Int          // 1-5
  voiceName     VoiceName?
  pitchClass    String       // e.g., "C", "C#", "Bb"
  octave        Int          // MIDI octave (4 = middle C octave)
  midiNumber    Int          // MIDI note number (60 = middle C)
  startBeat     Float        // Beat position in measure (1-based)
  durationBeats Float        // Duration in beats
  tiedFromId    String?      @unique // ID of note this is tied from
  tiedToId      String?      // ID of note this is tied to
  articulation  String[]     // e.g., ["staccato", "accent"]
  dynamic       String?      // e.g., "p", "f", "mf"
  ornament      String?      // e.g., "trill", "mordent"
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  measure  Measure @relation(fields: [measureId], references: [id], onDelete: Cascade)
  tiedFrom Note?   @relation("NoteTies", fields: [tiedFromId], references: [id])
  tiedTo   Note?   @relation("NoteTies")

  @@index([measureId])
  @@index([voice])
  @@index([midiNumber])
  @@index([startBeat])
}

enum AnnotationType {
  HARMONY        // Chord analysis, harmonic progressions
  CADENCE        // Cadence types and locations
  FORM           // Formal structure (exposition, development, etc.)
  TECHNIQUE      // Performance techniques
  FUGUE_ELEMENT  // Subject, answer, countersubject, stretto, etc.
  PHRASE         // Phrase boundaries and relationships
  PERFORMANCE    // Performance notes and suggestions
}

enum AnnotationSource {
  GENERATED // Auto-generated by analysis
  IMPORTED  // Imported from external source
  MANUAL    // Manually created by user/admin
}

model Annotation {
  id               String           @id @default(cuid())
  pieceId          String
  measureStart     Int              // Starting measure number
  measureEnd       Int              // Ending measure number (can equal measureStart)
  beatStart        Float?           // Starting beat (null = start of measure)
  beatEnd          Float?           // Ending beat (null = end of measure)
  annotationType   AnnotationType
  content          Json             // Flexible content structure
  displayText      String           // Human-readable text for display
  voicesInvolved   Int[]            // Which voices this annotation applies to
  layer            Int              @default(0) // For layering multiple annotations
  source           AnnotationSource @default(MANUAL)
  verified         Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  piece   Piece     @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  measure Measure?  @relation(fields: [measureStart, pieceId], references: [measureNumber, pieceId])

  @@index([pieceId])
  @@index([annotationType])
  @@index([measureStart, measureEnd])
}

// ============================================================================
// CURRICULUM MODELS
// ============================================================================

model Domain {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  orderIndex  Int      @unique
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  units Unit[]

  @@index([orderIndex])
}

model Unit {
  id          String   @id @default(cuid())
  domainId    String
  name        String
  description String
  orderIndex  Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  domain         Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)
  modules        Module[]
  prerequisites  Unit[]   @relation("UnitPrerequisites")
  dependentUnits Unit[]   @relation("UnitPrerequisites")

  @@unique([domainId, orderIndex])
  @@index([domainId])
}

model Module {
  id                      String   @id @default(cuid())
  unitId                  String
  name                    String
  description             String
  orderIndex              Int
  estimatedDurationMinutes Int?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  unit    Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@unique([unitId, orderIndex])
  @@index([unitId])
}

model Lesson {
  id               String   @id @default(cuid())
  moduleId         String
  name             String
  description      String
  orderIndex       Int
  contentVersion   Int      @default(1)
  sections         Json     // Structured lesson content
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  module       Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  userProgress UserProgress[]

  @@unique([moduleId, orderIndex])
  @@index([moduleId])
}

// ============================================================================
// FEATURE TAXONOMY MODELS
// ============================================================================

enum FeatureCategory {
  HARMONY
  COUNTERPOINT
  RHYTHM
  MELODY
  FORM
  TEXTURE
  FUGUE
  PERFORMANCE
  OTHER
}

model Feature {
  id                       String          @id @default(cuid())
  name                     String
  slug                     String          @unique
  category                 FeatureCategory
  parentFeatureId          String?
  description              String
  explanationBeginner      String?
  explanationIntermediate  String?
  explanationAdvanced      String?
  difficultyLevel          Int             @default(1) // 1-5
  searchKeywords           String[]
  icon                     String?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  parent           Feature?          @relation("FeatureHierarchy", fields: [parentFeatureId], references: [id])
  children         Feature[]         @relation("FeatureHierarchy")
  featureInstances FeatureInstance[]

  @@index([category])
  @@index([parentFeatureId])
  @@index([difficultyLevel])
}

model FeatureInstance {
  id              String               @id @default(cuid())
  featureId       String
  pieceId         String
  measureStart    Int
  measureEnd      Int
  beatStart       Float?
  beatEnd         Float?
  voicesInvolved  Int[]
  localKey        String?
  description     String?
  complexityScore Int?                 // 1-10
  qualityScore    Int?                 // 1-10 (how well-formed/canonical)
  verified        Boolean              @default(false)
  source          AnnotationSource     @default(GENERATED)
  metadata        Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  piece   Piece   @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([featureId])
  @@index([pieceId])
  @@index([measureStart, measureEnd])
  @@index([verified])
}

// ============================================================================
// USER PROGRESS TRACKING
// ============================================================================

enum EntityType {
  DOMAIN
  UNIT
  MODULE
  LESSON
  PIECE
  FEATURE
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model UserProgress {
  id             String         @id @default(cuid())
  userId         String         // External user ID (from auth system)
  entityType     EntityType
  entityId       String         // ID of domain/unit/module/lesson/piece/feature
  status         ProgressStatus @default(NOT_STARTED)
  startedAt      DateTime?
  completedAt    DateTime?
  lastAccessedAt DateTime       @default(now())
  metadata       Json?          // Custom progress data (scores, notes, etc.)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  lesson Lesson? @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([userId, entityType, entityId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([lastAccessedAt])
}
